<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Go Git Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2b2b2b;
            color: #a9b7c6;
            height: 100vh;
            overflow: hidden;
        }
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .toolbar {
            background-color: #3c3f41;
            padding: 8px 16px;
            border-bottom: 1px solid #4e5254;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toolbar input {
            background-color: #3c3f41;
            border: 1px solid #5e6366;
            color: #a9b7c6;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            width: 300px;
        }
        .toolbar input:focus {
            outline: none;
            border-color: #4a6d8c;
        }
        .toolbar button {
            background-color: #4a6d8c;
            border: none;
            color: #ffffff;
            padding: 6px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        .toolbar button:hover {
            background-color: #5c7d9e;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background-color: #313335;
            border-right: 1px solid #4e5254;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .file-panel {
            width: 350px;
            background-color: #313335;
            border-right: 1px solid #4e5254;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            background-color: #3c3f41;
            padding: 10px 16px;
            border-bottom: 1px solid #4e5254;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .branch-tree, .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .branch-group, .file-group {
            margin-bottom: 8px;
        }
        .group-header {
            padding: 8px 12px;
            background-color: #3c3f41;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: #a9b7c6;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .tree-item, .file-item {
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 20px;
        }
        .tree-item:hover, .file-item:hover {
            background-color: #4e5254;
        }
        .tree-item.active, .file-item.active {
            background-color: #4a6d8c;
            color: #ffffff;
        }
        .tree-item .icon, .file-item .icon {
            font-size: 14px;
        }
        .tree-item .branch-name, .file-item .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-item .status-icon {
            font-size: 12px;
        }
        .tree-item .branch-tag {
            background-color: #6a8759;
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        .commit-history, .diff-view {
            flex: 1;
            background-color: #2b2b2b;
            overflow-y: auto;
            padding: 16px;
        }
        .commit-item {
            background-color: #313335;
            border: 1px solid #4e5254;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border-color 0.2s;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .commit-item:hover {
            border-color: #4a6d8c;
            background-color: #36393a;
        }
        .commit-hash {
            color: #9876aa;
            font-weight: bold;
            margin-right: 12px;
        }
        .commit-message {
            color: #a9b7c6;
        }
        .diff-content {
            background-color: #1e1e1e;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .diff-content .diff-header {
            color: #808080;
            margin-bottom: 12px;
        }
        .diff-content .diff-add {
            color: #6a8759;
            background-color: rgba(106, 135, 89, 0.1);
        }
        .diff-content .diff-remove {
            color: #cc7832;
            background-color: rgba(204, 120, 50, 0.1);
        }
        .diff-content .diff-hunk {
            color: #9876aa;
            font-weight: bold;
        }
        .status-bar {
            background-color: #3c3f41;
            padding: 6px 16px;
            border-top: 1px solid #4e5254;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-indicator.connected {
            background-color: #6a8759;
        }
        .status-indicator.disconnected {
            background-color: #cc7832;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #808080;
        }
        .error-message {
            color: #cc7832;
            padding: 16px;
            text-align: center;
        }
        .action-buttons {
            display: flex;
            gap: 6px;
        }
        .action-buttons button {
            background-color: #4a6d8c;
            border: none;
            color: #ffffff;
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        .action-buttons button:hover {
            background-color: #5c7d9e;
        }
        .refresh-btn {
            background-color: transparent;
            border: 1px solid #5e6366;
            color: #a9b7c6;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .refresh-btn:hover {
            background-color: #4e5254;
        }
        .context-menu {
            position: fixed;
            background-color: #3c3f41;
            border: 1px solid #4e5254;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 150px;
            display: none;
        }
        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 13px;
            color: #a9b7c6;
        }
        .context-menu-item:hover {
            background-color: #4a6d8c;
            color: #ffffff;
        }
        .context-menu-item.disabled {
            color: #808080;
            cursor: not-allowed;
        }
        .context-menu-item.disabled:hover {
            background-color: transparent;
        }
        .tab-header {
            background-color: #3c3f41;
            padding: 8px 16px;
            border-bottom: 1px solid #4e5254;
            display: flex;
            gap: 8px;
        }
        .tab-btn {
            background: transparent;
            border: none;
            color: #a9b7c6;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        .tab-btn:hover {
            background-color: #4e5254;
        }
        .tab-btn.active {
            background-color: #4a6d8c;
            color: #ffffff;
        }
        .status-modified { color: #cc7832; }
        .status-added { color: #6a8759; }
        .status-deleted { color: #c0392b; }
        .status-renamed { color: #9876aa; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="toolbar">
            <input type="text" id="repoPath" placeholder="è¾“å…¥ Git ä»“åº“è·¯å¾„" value="">
            <button onclick="loadRepo()">åŠ è½½ä»“åº“</button>
            <button onclick="refreshData()">åˆ·æ–°</button>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šåˆ†æ”¯æ ‘ -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <span>ğŸŒ³ åˆ†æ”¯</span>
                    <div class="action-buttons">
                        <button onclick="createBranch()">æ–°å»ºåˆ†æ”¯</button>
                        <button class="refresh-btn" onclick="refreshBranches()">â†»</button>
                    </div>
                </div>
                <div class="branch-tree" id="branchTree">
                    <div class="loading">è¯·å…ˆåŠ è½½ä»“åº“...</div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šæ–‡ä»¶å˜æ›´åˆ—è¡¨ -->
            <div class="file-panel">
                <div class="sidebar-header">
                    <span>ğŸ“„ æ–‡ä»¶å˜æ›´</span>
                    <button class="refresh-btn" onclick="refreshFiles()">â†»</button>
                </div>
                <div class="file-list" id="fileList">
                    <div class="loading">è¯·å…ˆåŠ è½½ä»“åº“...</div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæäº¤å†å²æˆ– Diff è§†å›¾ -->
            <div class="diff-view">
                <div class="tab-header">
                    <button class="tab-btn active" id="tabCommits" onclick="switchTab('commits')">ğŸ“ æäº¤å†å²</button>
                    <button class="tab-btn" id="tabDiff" onclick="switchTab('diff')">ğŸ” Diff</button>
                    <span id="selectedInfo" style="color: #808080; font-size: 12px; margin-left: auto;"></span>
                </div>
                <div id="commitHistory">
                    <div class="loading">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†æ”¯æŸ¥çœ‹æäº¤å†å²...</div>
                </div>
                <div id="diffView" style="display: none;">
                    <div class="loading">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æŸ¥çœ‹ diff...</div>
                </div>
            </div>
        </div>

        <div class="status-bar">
            <div>
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="statusText">æœªåŠ è½½ä»“åº“</span>
            </div>
            <div id="repoInfo"></div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="menuCheckout">ğŸ”„ Checkout</div>
    </div>

    <script src="wailsjs/runtime/index.js"></script>
    <script>
        let currentRepoPath = '';
        let currentBranch = '';
        let selectedBranch = '';
        let selectedFile = null;
        let currentTab = 'commits';
        let wailsReady = false;
        let contextMenuTarget = null;

        // ç­‰å¾… Wails åˆå§‹åŒ–
        function waitForWails(callback, maxAttempts = 10, interval = 500) {
            let attempts = 0;
            
            function check() {
                attempts++;
                if (typeof window !== 'undefined' && window.go && window.go.main && window.go.main.App) {
                    console.log('Wails ç»‘å®šå·²å°±ç»ª');
                    wailsReady = true;
                    callback();
                } else if (attempts < maxAttempts) {
                    console.log(`ç­‰å¾… Wails ç»‘å®š... (${attempts}/${maxAttempts})`);
                    setTimeout(check, interval);
                } else {
                    console.error('Wails ç»‘å®šåˆå§‹åŒ–è¶…æ—¶');
                    alert('Wails ç»‘å®šåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
            }
            
            check();
        }

        async function loadRepo() {
            const path = document.getElementById('repoPath').value.trim();
            if (!path) {
                alert('è¯·è¾“å…¥ä»“åº“è·¯å¾„');
                return;
            }
            currentRepoPath = path;
            await refreshData();
        }

        async function refreshData() {
            if (!currentRepoPath) {
                return;
            }
            await Promise.all([
                loadBranches(),
                loadFiles(),
                loadCurrentBranch()
            ]);
            updateStatusBar();
        }

        async function loadBranches() {
            if (!currentRepoPath) return;
            
            const container = document.getElementById('branchTree');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                if (!window.go || !window.go.main || !window.go.main.App) {
                    throw new Error('Wails ç»‘å®šæœªå°±ç»ª');
                }
                
                // è·å–æœ¬åœ°åˆ†æ”¯
                const localResult = await window.go.main.App.GitLocalBranches(currentRepoPath);
                const localBranches = localResult.split('\n').filter(b => b.trim());
                
                // è·å–è¿œç¨‹åˆ†æ”¯
                const remoteResult = await window.go.main.App.GitRemoteBranches(currentRepoPath);
                const remoteBranches = remoteResult.split('\n').filter(b => b.trim());
                
                let html = '';

                // æœ¬åœ°åˆ†æ”¯ç»„
                html += '<div class="branch-group">';
                html += '<div class="group-header">ğŸ“ æœ¬åœ°åˆ†æ”¯</div>';
                
                if (localBranches.length === 0) {
                    html += '<div style="padding: 8px 12px; color: #808080; font-size: 12px;">æ— æœ¬åœ°åˆ†æ”¯</div>';
                } else {
                    localBranches.forEach(branch => {
                        const isCurrent = branch.startsWith('*');
                        const branchName = branch.replace(/^\*?\s*/, '').trim();
                        const itemClass = isCurrent ? 'tree-item active' : 'tree-item';
                        
                        html += `
                            <div class="${itemClass}" 
                                 onclick="selectBranch('${branchName}', 'local')"
                                 oncontextmenu="showContextMenu(event, '${branchName}', 'local')"
                                 data-branch="${branchName}"
                                 data-type="local">
                                <span class="icon">ğŸŒ¿</span>
                                <span class="branch-name">${branchName}</span>
                                ${isCurrent ? '<span class="branch-tag">å½“å‰</span>' : ''}
                            </div>
                        `;
                    });
                }
                html += '</div>';

                // è¿œç¨‹åˆ†æ”¯ç»„
                html += '<div class="branch-group">';
                html += '<div class="group-header">ğŸ“¡ è¿œç¨‹åˆ†æ”¯</div>';
                
                if (remoteBranches.length === 0) {
                    html += '<div style="padding: 8px 12px; color: #808080; font-size: 12px;">æ— è¿œç¨‹åˆ†æ”¯</div>';
                } else {
                    remoteBranches.forEach(branch => {
                        const branchName = branch.replace(/^\*?\s*/, '').trim();
                        const cleanName = branchName.replace('origin/', '');
                        const isCurrent = currentBranch === cleanName;
                        const itemClass = isCurrent ? 'tree-item active' : 'tree-item';
                        
                        html += `
                            <div class="${itemClass}" 
                                 onclick="selectBranch('${branchName}', 'remote')"
                                 oncontextmenu="showContextMenu(event, '${branchName}', 'remote')"
                                 data-branch="${branchName}"
                                 data-type="remote">
                                <span class="icon">ğŸ“¡</span>
                                <span class="branch-name">${cleanName}</span>
                            </div>
                        `;
                    });
                }
                html += '</div>';

                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½åˆ†æ”¯å¤±è´¥:', error);
                container.innerHTML = `<div class="error-message">åŠ è½½åˆ†æ”¯å¤±è´¥: ${error}</div>`;
            }
        }

        async function loadFiles() {
            if (!currentRepoPath) return;
            
            const container = document.getElementById('fileList');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                if (!window.go || !window.go.main || !window.go.main.App) {
                    throw new Error('Wails ç»‘å®šæœªå°±ç»ª');
                }
                
                const result = await window.go.main.App.GitDiffFiles(currentRepoPath);
                const files = result.split('\n').filter(f => f.trim());
                
                if (files.length === 0) {
                    container.innerHTML = '<div style="padding: 16px; color: #808080; font-size: 13px; text-align: center;">æ— æ–‡ä»¶å˜æ›´</div>';
                    return;
                }

                // åˆ†ç±»æ–‡ä»¶
                const stagedFiles = [];
                const unstagedFiles = [];
                
                files.forEach(file => {
                    if (file.length >= 2) {
                        const status = file.substring(0, 2);
                        const filename = file.substring(3);
                        const fileData = {
                            filename,
                            status,
                            staged: status[0] !== ' ' && status[0] !== '?',
                            unstaged: status[1] !== ' '
                        };
                        
                        if (fileData.staged) {
                            stagedFiles.push(fileData);
                        }
                        if (fileData.unstaged) {
                            unstagedFiles.push(fileData);
                        }
                    }
                });

                let html = '';

                // æš‚å­˜åŒºæ–‡ä»¶
                if (stagedFiles.length > 0) {
                    html += '<div class="file-group">';
                    html += '<div class="group-header">âœ… æš‚å­˜åŒº</div>';
                    stagedFiles.forEach(file => {
                        const statusClass = getStatusClass(file.status[0]);
                        const statusIcon = getStatusIcon(file.status[0]);
                        html += `
                            <div class="file-item" 
                                 onclick="selectFile('${file.filename}', true)"
                                 data-file="${file.filename}">
                                <span class="icon">${statusIcon}</span>
                                <span class="file-name">${file.filename}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                // å·¥ä½œåŒºæ–‡ä»¶
                if (unstagedFiles.length > 0) {
                    html += '<div class="file-group">';
                    html += '<div class="group-header">ğŸ“ å·¥ä½œåŒº</div>';
                    unstagedFiles.forEach(file => {
                        const statusClass = getStatusClass(file.status[1]);
                        const statusIcon = getStatusIcon(file.status[1]);
                        html += `
                            <div class="file-item" 
                                 onclick="selectFile('${file.filename}', false)"
                                 data-file="${file.filename}">
                                <span class="icon">${statusIcon}</span>
                                <span class="file-name">${file.filename}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
                container.innerHTML = `<div class="error-message">åŠ è½½æ–‡ä»¶å¤±è´¥: ${error}</div>`;
            }
        }

        function getStatusClass(status) {
            switch (status) {
                case 'M': return 'status-modified';
                case 'A': return 'status-added';
                case 'D': return 'status-deleted';
                case 'R': return 'status-renamed';
                default: return '';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'M': return 'âœï¸';
                case 'A': return 'â•';
                case 'D': return 'ğŸ—‘ï¸';
                case 'R': return 'ğŸ”„';
                case '?': return 'â“';
                default: return 'ğŸ“„';
            }
        }

        async function selectBranch(branchName, type) {
            console.log(`é€‰æ‹©åˆ†æ”¯: ${branchName} (${type})`);
            selectedBranch = branchName;
            selectedFile = null;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[data-branch="${branchName}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('selectedInfo').textContent = `- ${branchName}`;
            
            // åˆ‡æ¢åˆ°æäº¤å†å²æ ‡ç­¾
            switchTab('commits');
            
            // åŠ è½½è¯¥åˆ†æ”¯çš„æäº¤å†å²
            await loadBranchLog(branchName);
        }

        async function selectFile(filename, staged) {
            console.log(`é€‰æ‹©æ–‡ä»¶: ${filename} (staged: ${staged})`);
            selectedFile = { filename, staged };
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[data-file="${filename}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('selectedInfo').textContent = `- ${filename}`;
            
            // åˆ‡æ¢åˆ° diff æ ‡ç­¾
            switchTab('diff');
            
            // åŠ è½½æ–‡ä»¶ diff
            await loadFileDiff(filename, staged);
        }

        async function loadBranchLog(branchName) {
            if (!currentRepoPath || !branchName) return;
            
            const container = document.getElementById('commitHistory');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                if (!window.go || !window.go.main || !window.go.main.App) {
                    throw new Error('Wails ç»‘å®šæœªå°±ç»ª');
                }
                
                const result = await window.go.main.App.GitBranchLog(currentRepoPath, branchName, 100);
                const commits = result.split('\n').filter(c => c.trim());
                
                if (commits.length === 0) {
                    container.innerHTML = '<div class="error-message">æœªæ‰¾åˆ°æäº¤è®°å½•</div>';
                    return;
                }

                let html = '';
                commits.forEach(commit => {
                    const spaceIndex = commit.indexOf(' ');
                    if (spaceIndex > 0) {
                        const hash = commit.substring(0, spaceIndex);
                        const message = commit.substring(spaceIndex + 1);
                        
                        html += `
                            <div class="commit-item">
                                <span class="commit-hash">${hash}</span>
                                <span class="commit-message">${message}</span>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html;
            } catch (error) {
                console.error('åŠ è½½æäº¤å†å²å¤±è´¥:', error);
                container.innerHTML = `<div class="error-message">åŠ è½½æäº¤å†å²å¤±è´¥: ${error}</div>`;
            }
        }

        async function loadFileDiff(filename, staged) {
            if (!currentRepoPath || !filename) return;
            
            const container = document.getElementById('diffView');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                if (!window.go || !window.go.main || !window.go.main.App) {
                    throw new Error('Wails ç»‘å®šæœªå°±ç»ª');
                }
                
                const result = await window.go.main.App.GitFileDiff(currentRepoPath, filename, staged);
                
                // æ ¼å¼åŒ– diff è¾“å‡º
                const formattedDiff = formatDiff(result);
                
                container.innerHTML = `<div class="diff-content">${formattedDiff}</div>`;
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶ diff å¤±è´¥:', error);
                container.innerHTML = `<div class="error-message">åŠ è½½æ–‡ä»¶ diff å¤±è´¥: ${error}</div>`;
            }
        }

        function formatDiff(diff) {
            const lines = diff.split('\n');
            let html = '';
            
            lines.forEach(line => {
                if (line.startsWith('diff --git')) {
                    html += `<div class="diff-header">${line}</div>`;
                } else if (line.startsWith('@@')) {
                    html += `<div class="diff-hunk">${line}</div>`;
                } else if (line.startsWith('+') && !line.startsWith('+++')) {
                    html += `<div class="diff-add">${escapeHtml(line)}</div>`;
                } else if (line.startsWith('-') && !line.startsWith('---')) {
                    html += `<div class="diff-remove">${escapeHtml(line)}</div>`;
                } else {
                    html += `<div>${escapeHtml(line)}</div>`;
                }
            });
            
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function switchTab(tab) {
            currentTab = tab;
            
            const tabCommits = document.getElementById('tabCommits');
            const tabDiff = document.getElementById('tabDiff');
            const commitHistory = document.getElementById('commitHistory');
            const diffView = document.getElementById('diffView');
            
            if (tab === 'commits') {
                tabCommits.classList.add('active');
                tabDiff.classList.remove('active');
                commitHistory.style.display = 'block';
                diffView.style.display = 'none';
                document.getElementById('selectedInfo').textContent = selectedBranch ? `- ${selectedBranch}` : '';
            } else {
                tabCommits.classList.remove('active');
                tabDiff.classList.add('active');
                commitHistory.style.display = 'none';
                diffView.style.display = 'block';
                document.getElementById('selectedInfo').textContent = selectedFile ? `- ${selectedFile.filename}` : '';
            }
        }

        function showContextMenu(event, branchName, type) {
            event.preventDefault();
            
            contextMenuTarget = { branchName, type };
            
            const menu = document.getElementById('contextMenu');
            const menuCheckout = document.getElementById('menuCheckout');
            
            const cleanName = branchName.replace('origin/', '');
            const isCurrent = currentBranch === cleanName;
            
            if (isCurrent) {
                menuCheckout.classList.add('disabled');
            } else {
                menuCheckout.classList.remove('disabled');
            }
            
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
            contextMenuTarget = null;
        }

        async function checkoutBranch() {
            if (!contextMenuTarget) return;
            
            const { branchName, type } = contextMenuTarget;
            let checkoutBranch = branchName;
            
            if (type === 'remote') {
                checkoutBranch = branchName.replace('origin/', '');
                if (!confirm(`è¦ä»è¿œç¨‹åˆ†æ”¯ "${checkoutBranch}" åˆ›å»ºå¹¶åˆ‡æ¢åˆ°æœ¬åœ°åˆ†æ”¯å—ï¼Ÿ`)) {
                    hideContextMenu();
                    return;
                }
            } else {
                if (!confirm(`ç¡®å®šè¦åˆ‡æ¢åˆ°åˆ†æ”¯ "${checkoutBranch}" å—ï¼Ÿ`)) {
                    hideContextMenu();
                    return;
                }
            }

            try {
                await window.go.main.App.GitCheckout(currentRepoPath, checkoutBranch);
                await refreshData();
                alert(`å·²åˆ‡æ¢åˆ°åˆ†æ”¯ ${checkoutBranch}`);
            } catch (error) {
                alert(`åˆ‡æ¢åˆ†æ”¯å¤±è´¥: ${error}`);
            }
            
            hideContextMenu();
        }

        document.addEventListener('click', hideContextMenu);

        document.getElementById('menuCheckout').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) {
                checkoutBranch();
            }
        });

        async function loadCurrentBranch() {
            if (!currentRepoPath) return;

            try {
                if (!window.go || !window.go.main || !window.go.main.App) {
                    return;
                }
                
                const result = await window.go.main.App.GitGetCurrentBranch(currentRepoPath);
                currentBranch = result.trim();
            } catch (error) {
                console.error('è·å–å½“å‰åˆ†æ”¯å¤±è´¥:', error);
            }
        }

        async function createBranch() {
            if (!currentRepoPath) {
                alert('è¯·å…ˆåŠ è½½ä»“åº“');
                return;
            }

            const branchName = prompt('è¯·è¾“å…¥æ–°åˆ†æ”¯åç§°:');
            if (!branchName) return;

            try {
                await window.go.main.App.GitCreateBranch(currentRepoPath, branchName);
                await refreshData();
                alert(`å·²åˆ›å»ºå¹¶åˆ‡æ¢åˆ°åˆ†æ”¯ ${branchName}`);
            } catch (error) {
                alert(`åˆ›å»ºåˆ†æ”¯å¤±è´¥: ${error}`);
            }
        }

        async function refreshBranches() {
            await loadBranches();
        }

        async function refreshFiles() {
            await loadFiles();
        }

        function updateStatusBar() {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const repoInfo = document.getElementById('repoInfo');

            if (currentRepoPath) {
                indicator.className = 'status-indicator connected';
                statusText.textContent = currentBranch ? `å½“å‰åˆ†æ”¯: ${currentBranch}` : 'æœªçŸ¥åˆ†æ”¯';
                repoInfo.textContent = currentRepoPath;
            } else {
                indicator.className = 'status-indicator disconnected';
                statusText.textContent = 'æœªåŠ è½½ä»“åº“';
                repoInfo.textContent = '';
            }
        }

        window.onload = function() {
            document.getElementById('repoPath').value = 'D:\\workspace\\go-git-client-window';
            
            waitForWails(() => {
                console.log('Wails å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨');
            });
        };
    </script>
</body>
</html>